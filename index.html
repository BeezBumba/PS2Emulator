<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <link rel="icon" href="/favicon.ico"/>
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,orientation=landscape"/>
        <meta name="theme-color" content="#000000"/>
        <meta name="description" content="A PlayStation2 emulator for web browsers"/>
        <meta name="google-adsense-account" content="ca-pub-6468293492439852">
        <link rel="apple-touch-icon" href="/play-192.png"/>
        <link rel="manifest" href="/manifest.json"/>
        <title>Play!.js</title>
       
        <style>
            @media screen and (orientation: portrait) {
                #orientation-warning {
                    display:flex!important
                }

                #mobile-controls {
                    display: none!important
                }
            }

            #orientation-warning {
                display: none;
                position: fixed;
                left: 0;
                top: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,.85);
                color: #fff;
                z-index: 3000;
                align-items: center;
                justify-content: center;
                text-align: center;
                font-size: 2em;
                padding: 2em
            }

            body {
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                margin: 0;
                padding: 0;
                width: 100vw;
                height: 100vh;
                overflow: hidden;
                background: #000;
            }

            /* FIXED: React file input positioning - collapsible at top */
            #root {
                position: fixed;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                z-index: 10;
                pointer-events: auto;
            }

            /* File import toggle button */
            #file-import-toggle {
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 11;
                background: #333;
                color: #fff;
                border: none;
                border-radius: 6px;
                padding: 8px 12px;
                cursor: pointer;
                font-size: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                transition: background 0.2s;
            }

            #file-import-toggle:hover {
                background: #444;
            }

            /* Settings toggle button */
            #settings-toggle {
                position: fixed;
                top: 20px;
                left: 120px;
                z-index: 11;
                background: #333;
                color: #fff;
                border: none;
                border-radius: 6px;
                padding: 8px 12px;
                cursor: pointer;
                font-size: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                transition: background 0.2s;
            }

            #settings-toggle:hover {
                background: #444;
            }

            /* Settings panel - EXPANDED for save states */
            #settings-panel {
                position: fixed;
                top: 60px;
                left: 120px;
                z-index: 10;
                background: rgba(0, 0, 0, 0.95);
                padding: 16px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                border: 1px solid #444;
                transform: translateY(-100%);
                opacity: 0;
                transition: all 0.3s ease;
                pointer-events: none;
                min-width: 280px;
                max-height: 80vh;
                overflow-y: auto;
            }

            #settings-panel.expanded {
                transform: translateY(0);
                opacity: 1;
                pointer-events: auto;
            }

            #settings-panel .section {
                margin-bottom: 20px;
                padding-bottom: 16px;
                border-bottom: 1px solid #555;
            }

            #settings-panel .section:last-child {
                margin-bottom: 0;
                padding-bottom: 0;
                border-bottom: none;
            }

            #settings-panel .section-title {
                color: #fff;
                font-weight: bold;
                font-size: 16px;
                margin-bottom: 12px;
                display: block;
            }

            #settings-panel label {
                display: block;
                color: #ccc;
                font-weight: bold;
                margin-bottom: 8px;
                font-size: 14px;
            }

            #settings-panel select {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #666;
                border-radius: 4px;
                background-color: #444;
                color: #fff;
                font-size: 14px;
                cursor: pointer;
                font-family: inherit;
                margin-bottom: 12px;
            }

            #settings-panel select:hover {
                background-color: #555;
                border-color: #777;
            }

            #settings-panel select:focus {
                outline: none;
                border-color: #007bff;
                box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
            }

            /* Save state controls */
            .save-slots {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
                margin-bottom: 12px;
            }

            .save-slot {
                padding: 8px 4px;
                border: 1px solid #666;
                border-radius: 4px;
                background-color: #444;
                color: #fff;
                font-size: 12px;
                cursor: pointer;
                text-align: center;
                transition: all 0.2s;
            }

            .save-slot:hover {
                background-color: #555;
                border-color: #777;
            }

            .save-slot.has-save {
                border-color: #4CAF50;
                background-color: #2d5a2d;
            }

            .save-slot.selected {
                border-color: #007bff;
                background-color: #1a4480;
            }

            .save-actions {
                display: flex;
                gap: 8px;
                margin-bottom: 12px;
            }

            .save-actions button {
                flex: 1;
                padding: 8px 12px;
                border: 1px solid #666;
                border-radius: 4px;
                background-color: #444;
                color: #fff;
                font-size: 13px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .save-actions button:hover:not(:disabled) {
                background-color: #555;
                border-color: #777;
            }

            .save-actions button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

            .save-actions .save-btn {
                background-color: #2d5a2d;
                border-color: #4CAF50;
            }

            .save-actions .load-btn {
                background-color: #1a4480;
                border-color: #007bff;
            }

            .import-export {
                display: flex;
                gap: 8px;
            }

            .import-export button {
                flex: 1;
                padding: 6px 10px;
                border: 1px solid #666;
                border-radius: 4px;
                background-color: #444;
                color: #fff;
                font-size: 12px;
                cursor: pointer;
                transition: all 0.2s;
            }

            .import-export button:hover {
                background-color: #555;
                border-color: #777;
            }

            .import-export input[type="file"] {
                display: none;
            }

            /* Collapsible file import panel */
            #root > div {
                background: rgba(0, 0, 0, 0.95);
                padding: 12px 16px;
                border-radius: 0 0 8px 8px;
                display: flex;
                align-items: center;
                gap: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                border: 1px solid #444;
                border-top: none;
                transform: translateY(-100%);
                transition: transform 0.3s ease;
                min-width: 300px;
                justify-content: center;
            }

            #root.expanded > div {
                transform: translateY(0);
            }

            #root input[type="file"] {
                background: #444;
                color: #fff;
                border: 1px solid #666;
                border-radius: 4px;
                padding: 6px 10px;
                font-size: 14px;
                cursor: pointer;
                font-family: inherit;
            }

            #root input[type="file"]::-webkit-file-upload-button {
                background: #555;
                color: #fff;
                border: none;
                border-radius: 3px;
                padding: 4px 8px;
                margin-right: 8px;
                cursor: pointer;
                font-size: 12px;
            }

            #root input[type="file"]:hover {
                background: #555;
                border-color: #777;
            }

            #root .stats, #root .version {
                color: #ccc;
                font-size: 12px;
                font-family: monospace;
                white-space: nowrap;
            }

            #root .stats {
                color: #4CAF50;
            }

            #root .version {
                color: #2196F3;
            }

            #outputCanvas {
                display: block;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%,-50%);
                background: #000;
                z-index: 1;
                width: 100vw;
                height: 56.25vw;
                max-width: 100vw;
                max-height: 100vh;
                border-radius: 0
            }

            @media (max-width: 900px) and (orientation:landscape) {
                #outputCanvas {
                    width:100vw;
                    height: 56.25vw;
                    max-height: 100vh;
                    max-width: 100vw
                }
            }

            @media (max-width: 900px) and (orientation:portrait) {
                #outputCanvas {
                    width:100vw;
                    height: 100vw;
                    max-height: 100vh;
                    max-width: 100vw
                }
            }

            /* Touch controls toggle button */
            #touch-controls-toggle {
                position: fixed;
                top: 32px;
                right: 0;
                z-index: 2001;
                background: #222;
                color: #fff;
                border: none;
                border-radius: 8px 0 0 8px;
                box-shadow: 0 2px 8px #0004;
                padding: 8px 12px;
                cursor: pointer;
                transition: right .3s;
                font-size: 1.2em;
            }

            /* Touch controls visibility - FIXED: Complete transparency and disabled interaction */
            #mobile-controls.hidden {
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }

            .mc-actions button:active,.mc-center-buttons button:active,.mc-dpad button:active,.mc-joystick .thumbstick:active,.mc-shoulder-left button:active,.mc-shoulder-right button:active {
                filter: brightness(1.5) drop-shadow(0 0 8px #fff8);
                outline: 2px solid #fff;
                box-shadow: 0 0 16px #fff8
            }

            .mc-actions button.pressed,.mc-center-buttons button.pressed,.mc-dpad button.pressed,.mc-joystick .thumbstick.pressed,.mc-shoulder-left button.pressed,.mc-shoulder-right button.pressed {
                filter: brightness(1.5) drop-shadow(0 0 8px #fff8);
                outline: 2px solid #fff;
                box-shadow: 0 0 16px #fff8
            }

            #mobile-controls {
                position: fixed;
                left: 0;
                bottom: 0;
                width: 100vw;
                height: auto;
                pointer-events: none;
                z-index: 1000;
                display: flex;
                flex-direction: column;
                justify-content: flex-end;
                align-items: center
            }

            .mc-grid-container {
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                width: 100%;
                padding: 0 3vw 2vh
            }

            .mc-left-column,.mc-right-column {
                display: flex;
                flex-direction: row;
                align-items: flex-end;
                gap: 20px;
                pointer-events: auto
            }

            .mc-center-buttons {
                pointer-events: auto;
                display: flex;
                align-items: center;
                gap: 16px;
                margin-bottom: 16px
            }

            .mc-center-buttons button {
                border-radius: 8px;
                padding: 8px 12px;
                font-size: .9em;
                background: #34495e;
                color: #fff;
                border: none;
                box-shadow: 0 2px 8px #0004
            }

            .mc-dpad {
                width: 160px;
                height: 160px;
                display: grid;
                grid-template-areas: ". up ." "left center right" ". down .";
                grid-template-columns: 1fr 1fr 1fr;
                grid-template-rows: 1fr 1fr 1fr;
                gap: 8px
            }

            .mc-dpad button {
                border-radius: 50%;
                width: 48px;
                height: 48px;
                font-size: 1.5em;
                background: #222;
                color: #fff;
                border: none;
                box-shadow: 0 2px 8px #0004;
            }

            .mc-dpad .up {
                grid-area: up;
            }

            .mc-dpad .down {
                grid-area: down;
            }

            .mc-dpad .left {
                grid-area: left;
            }

            .mc-dpad .right {
                grid-area: right;
            }

            .mc-dpad .center {
                grid-area: center;
                opacity: 0
            }

            .mc-actions {
                width: 180px;
                height: 200px;
                display: grid;
                grid-template-areas: 
                    ". . triangle . ."
                    ". square . circle ."
                    ". . cross . ."
                    ". . . . .";
                grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
                grid-template-rows: 1fr 1fr 1fr 1fr;
                gap: 4px;
                align-items: center;
                justify-items: center;
            }

            .mc-actions button {
                border-radius: 50%;
                width: 54px;
                height: 54px;
                font-size: 1.2em;
                border: none;
                box-shadow: 0 2px 8px #0004
            }

            .mc-actions .triangle {
                grid-area: triangle;
                background: #333;
                color: #3ee3a1;
                border: 2px solid #555;
            }

            .mc-actions .square {
                grid-area: square;
                background: #333;
                color: #ff69f8;
                border: 2px solid #555;
            }

            .mc-actions .cross {
                grid-area: cross;
                background: #333;
                color: #7db3e9;
                border: 2px solid #555;
            }

            .mc-actions .circle {
                grid-area: circle;
                background: #333;
                color: #ff6666;
                border: 2px solid #555;
            }

            .mc-shoulder-left,.mc-shoulder-right {
                display: flex;
                flex-direction: column;
                gap: 8px
            }

            .mc-shoulder-left button,.mc-shoulder-right button {
                border-radius: 8px;
                padding: 8px 12px;
                font-size: .9em;
                background: #34495e;
                color: #fff;
                border: none;
                box-shadow: 0 2px 8px #0004
            }

            .mc-joystick {
                width: 120px;
                height: 120px;
                background: rgba(34,34,34,.5);
                border-radius: 50%;
                position: relative;
                box-shadow: 0 2px 8px #0004;
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none
            }

            .mc-joystick .thumbstick {
                width: 60px;
                height: 60px;
                background: #ddd;
                border-radius: 50%;
                box-shadow: inset 0 2px 4px #0004,0 1px 2px #fff8;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%,-50%);
                touch-action: none;
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none
            }
        </style>
        <script defer="defer" src="/static/js/main.bedb2a19.js"></script>
        <script defer src="/register.js"></script>
        <link href="/static/css/main.5a525eca.css" rel="stylesheet">
    </head>
    <body>
        <noscript>You need to enable JavaScript to run this app.</noscript>
        <div class="global-row">
            <div class="global-column">
                <div>
                    <canvas id="outputCanvas" width="640" height="480" tabindex="-1"/>
                    <div style="margin:16px 0">
                        <label for="main-file-input" style="font-weight:700;display:block;margin-bottom:8px">Choose a game file:</label>
                        <input type="file" id="main-file-input" style="width:100%;max-width:320px"/>
                    </div>
                </div>
                <button id="touch-controls-toggle" aria-label="Toggle touch controls">
                    🎮
                </button>
                <button id="file-import-toggle" aria-label="File Import">
                    📁
                </button>
                <button id="settings-toggle" aria-label="Settings">
                    🔧
                </button>
                <div id="settings-panel">
                    <!-- Resolution Section -->
                    <div class="section">
                        <span class="section-title">🎮 Graphics</span>
                        <label for="resolution-select">Resolution Scale:</label>
                        <select id="resolution-select">
                            <option value="1">1x (640×480)</option>
                            <option value="2">2x (1280×960)</option>
                            <option value="3">3x (1920×1440)</option>
                        </select>
                    </div>

                    <!-- Save States Section -->
                    <div class="section">
                        <span class="section-title">💾 Save States</span>
                        <label>Select Save Slot:</label>
                        <div class="save-slots">
                            <div class="save-slot" data-slot="0">Slot 0</div>
                            <div class="save-slot" data-slot="1">Slot 1</div>
                            <div class="save-slot" data-slot="2">Slot 2</div>
                            <div class="save-slot" data-slot="3">Slot 3</div>
                            <div class="save-slot" data-slot="4">Slot 4</div>
                        </div>
                        <div class="save-actions">
                            <button id="save-state-btn" class="save-btn">💾 Save</button>
                            <button id="load-state-btn" class="load-btn" disabled>📁 Load</button>
                        </div>
                        <div class="import-export">
                            <button id="export-saves-btn">📤 Export All</button>
                            <button id="import-saves-btn">📥 Import</button>
                            <input type="file" id="import-saves-input" accept=".zip,.p2s" multiple>
                        </div>
                    </div>
                </div>
                <div id="root"></div>
                <div id="mobile-controls">
                    <div class="mc-grid-container">
                        <div class="mc-left-column">
                            <div class="mc-shoulder-left">
                                <button data-key="1">L1</button>
                                <button data-key="2">L2</button>
                                <button data-key="3">L3</button>
                            </div>
                            <div class="mc-left-side-stack">
                                <div class="mc-dpad">
                                    <button class="up" data-key="ArrowUp">▲</button>
                                    <button class="left" data-key="ArrowLeft">◀</button>
                                    <button class="center" tabindex="-1"></button>
                                    <button class="right" data-key="ArrowRight">▶</button>
                                    <button class="down" data-key="ArrowDown">▼</button>
                                </div>
                                <div id="left-joystick" class="mc-joystick">
                                    <div class="thumbstick"></div>
                                </div>
                            </div>
                        </div>
                        <div class="mc-center-buttons">
                            <button data-key="Backspace">SELECT</button>
                            <button data-key="Enter">START</button>
                        </div>
                        <div class="mc-right-column">
                            <div class="mc-right-side-stack">
                                <div class="mc-actions">
                                    <button class="cross" data-key="Z">✕</button>
                                    <button class="square" data-key="A">□</button>
                                    <button class="triangle" data-key="S">△</button>
                                    <button class="circle" data-key="X">◯</button>
                                </div>
                                <div id="right-joystick" class="mc-joystick">
                                    <div class="thumbstick"></div>
                                </div>
                            </div>
                            <div class="mc-shoulder-right">
                                <button data-key="8">R1</button>
                                <button data-key="9">R2</button>
                                <button data-key="0">R3</button>
                            </div>
                        </div>
                    </div>
                </div>
           
                <div id="orientation-warning">
                    <div>
                        <div style="font-size:3em;margin-bottom:0.5em">📱</div>
                        <div>Please rotate your device to landscape mode for the best gaming experience</div>
                    </div>
                </div>

                <script>
                    document.addEventListener("DOMContentLoaded", (function() {
                        // Save state functionality
                        let selectedSlot = 0;
                        
                        function updateSaveSlots() {
                            document.querySelectorAll('.save-slot').forEach(slot => {
                                const slotNum = parseInt(slot.dataset.slot);
                                slot.classList.remove('selected', 'has-save');
                                
                                if (slotNum === selectedSlot) {
                                    slot.classList.add('selected');
                                }
                                
                                // Check if slot has save state
                                if (window.PlayModule && window.PlayModule.hasState) {
                                    try {
                                        if (window.PlayModule.hasState(slotNum)) {
                                            slot.classList.add('has-save');
                                        }
                                    } catch (e) {
                                        console.log('Could not check save state for slot', slotNum);
                                    }
                                }
                            });
                            
                            // Update load button state
                            const loadBtn = document.getElementById('load-state-btn');
                            const hasCurrentSlotSave = document.querySelector(`[data-slot="${selectedSlot}"]`).classList.contains('has-save');
                            loadBtn.disabled = !hasCurrentSlotSave;
                        }
                        
                        // Save slot selection
                        document.querySelectorAll('.save-slot').forEach(slot => {
                            slot.addEventListener('click', function() {
                                selectedSlot = parseInt(this.dataset.slot);
                                updateSaveSlots();
                            });
                        });
                        
                        // Save state button
                        document.getElementById('save-state-btn').addEventListener('click', function() {
                            if (window.PlayModule && window.PlayModule.saveState) {
                                try {
                                    window.PlayModule.saveState(selectedSlot);
                                    console.log(`State saved to slot ${selectedSlot}`);
                                    setTimeout(updateSaveSlots, 500); // Update UI after save
                                } catch (e) {
                                    console.error('Failed to save state:', e);
                                    alert('Failed to save state. Make sure a game is loaded.');
                                }
                            } else {
                                alert('Save state not available. Make sure the emulator is loaded.');
                            }
                        });
                        
                        // Load state button
                        document.getElementById('load-state-btn').addEventListener('click', function() {
                            if (window.PlayModule && window.PlayModule.loadState) {
                                try {
                                    window.PlayModule.loadState(selectedSlot);
                                    console.log(`State loaded from slot ${selectedSlot}`);
                                } catch (e) {
                                    console.error('Failed to load state:', e);
                                    alert('Failed to load state from this slot.');
                                }
                            } else {
                                alert('Load state not available. Make sure the emulator is loaded.');
                            }
                        });
                        
                        // Export saves button
                        document.getElementById('export-saves-btn').addEventListener('click', function() {
                            // TODO: Implement save export functionality
                            alert('Export functionality coming soon!');
                        });
                        
                        // Import saves button
                        document.getElementById('import-saves-btn').addEventListener('click', function() {
                            document.getElementById('import-saves-input').click();
                        });
                        
                        // Import saves file input
                        document.getElementById('import-saves-input').addEventListener('change', function(e) {
                            // TODO: Implement save import functionality
                            if (e.target.files.length > 0) {
                                alert('Import functionality coming soon!');
                            }
                        });
                        
                        // Update save slots periodically
                        setInterval(updateSaveSlots, 2000);

                        // Mobile controls functionality
                        const mobileControls = document.getElementById("mobile-controls");
                        const touchControlsToggle = document.getElementById("touch-controls-toggle");
                        
                        let controlsVisible = false;
                        
                        function toggleTouchControls() {
                            controlsVisible = !controlsVisible;
                            if (controlsVisible) {
                                mobileControls.classList.remove('hidden');
                                touchControlsToggle.style.right = '0';
                            } else {
                                mobileControls.classList.add('hidden');
                                touchControlsToggle.style.right = '-10px';
                            }
                        }
                        
                        // Initially hide controls
                        mobileControls.classList.add('hidden');
                        touchControlsToggle.style.right = '-10px';
                        
                        touchControlsToggle.addEventListener('click', toggleTouchControls);

                        // File import functionality
                        const rootDiv = document.getElementById("root");
                        const fileImportToggle = document.getElementById("file-import-toggle");
                        
                        function toggleFileImport() {
                            rootDiv.classList.toggle('expanded');
                        }
                        
                        fileImportToggle.addEventListener('click', toggleFileImport);

                        // Settings panel functionality
                        const settingsToggle = document.getElementById("settings-toggle");
                        const settingsPanel = document.getElementById("settings-panel");
                        const resolutionSelect = document.getElementById("resolution-select");

                        settingsToggle.addEventListener('click', function() {
                            settingsPanel.classList.toggle('expanded');
                            // Update save slots when panel opens
                            if (settingsPanel.classList.contains('expanded')) {
                                setTimeout(updateSaveSlots, 100);
                            }
                        });

                        resolutionSelect.addEventListener('change', function(e) {
                            const newScale = parseInt(e.target.value);
                            
                            // Wait for React app to be ready
                            setTimeout(() => {
                                if (window.PlayModule && window.PlayModule.setResolutionScale) {
                                    window.PlayModule.setResolutionScale(newScale);
                                    console.log('Resolution set to:', newScale + 'x');
                                }
                            }, 100);
                            
                            // Auto-hide panel
                            setTimeout(() => {
                                settingsPanel.classList.remove('expanded');
                            }, 1000);
                        });

                        // Auto-hide file import panel after file selection
                        const observer = new MutationObserver(function(mutations) {
                            mutations.forEach(function(mutation) {
                                if (mutation.type === 'childList' && rootDiv.children.length > 0) {
                                    const fileInput = rootDiv.querySelector('input[type="file"]');
                                    if (fileInput) {
                                        fileInput.addEventListener('change', function() {
                                            if (this.files.length > 0) {
                                                setTimeout(() => {
                                                    rootDiv.classList.remove('expanded');
                                                }, 1000);
                                            }
                                        });
                                    }
                                }
                            });
                        });

                        observer.observe(rootDiv, { childList: true, subtree: true });

                        // COPIED EXACT BUTTON LOGIC FROM WORKING FILE
                        const i = document.getElementById("outputCanvas");
                        function d(e, t="Message") {
                            const n = `\n                  <div id="custom-modal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; justify-content: center; align-items: center;">\n                      <div style="background: white; padding: 20px; border-radius: 10px; text-align: center; max-width: 80%; box-shadow: 0 4px 8px rgba(0,0,0,0.2);">\n                          <h3 style="margin-top: 0;">${t}</h3>\n                          <p>${e}</p>\n                          <button id="close-modal" style="padding: 8px 16px; margin-top: 10px; border: none; border-radius: 5px; background: #3498db; color: white; cursor: pointer;">OK</button>\n                      </div>\n                  </div>\n              `;
                            document.body.insertAdjacentHTML("beforeend", n),
                            document.getElementById("close-modal").addEventListener("click", ( () => {
                                document.getElementById("custom-modal").remove()
                            }
                            ))
                        }
                        function s(e, t) {
                            // FIXED: Don't dispatch events if controls are hidden
                            if (mobileControls.classList.contains('hidden')) {
                                return;
                            }
                            
                            let n = "";
                            1 === e.length ? n = "Key" + e.toUpperCase() : "Enter" === e ? n = "Enter" : "Backspace" === e ? n = "Backspace" : e.startsWith("Arrow") ? n = e : ["1", "2", "3", "8", "9", "0"].includes(e) && (n = "Digit" + e);
                            const o = new KeyboardEvent(t,{
                                key: e,
                                code: n,
                                bubbles: !0,
                                cancelable: !0,
                                isTrusted: !0
                            });
                            i && i.dispatchEvent(o),
                            window.dispatchEvent(o),
                            document.dispatchEvent(o)
                        }
                        function c(e, t) {
                            // FIXED: Don't add pressed class or dispatch events if controls are hidden
                            if (mobileControls.classList.contains('hidden')) {
                                return;
                            }
                            
                            e.classList.add("pressed"),
                            s(t, "keydown"),
                            console.log(`Keydown event dispatched for: ${t}`)
                        }
                        function a(e, t) {
                            // FIXED: Don't remove pressed class or dispatch events if controls are hidden
                            if (mobileControls.classList.contains('hidden')) {
                                return;
                            }
                            
                            e.classList.remove("pressed"),
                            s(t, "keyup"),
                            console.log(`Keyup event dispatched for: ${t}`)
                        }
                        document.querySelectorAll("#mobile-controls button[data-key]").forEach((function(e) {
                            const t = e.getAttribute("data-key");
                            e.addEventListener("touchstart", (function(n) {
                                n.preventDefault(),
                                c(e, t)
                            }
                            )),
                            e.addEventListener("mousedown", (function(n) {
                                n.preventDefault(),
                                c(e, t)
                            }
                            )),
                            e.addEventListener("touchend", (function(n) {
                                n.preventDefault(),
                                a(e, t)
                            }
                            )),
                            e.addEventListener("mouseup", (function(n) {
                                n.preventDefault(),
                                a(e, t)
                            }
                            )),
                            e.addEventListener("mouseleave", (function(n) {
                                1 === n.buttons && a(e, t)
                            }
                            ))
                        }
                        ));
                        const l = document.getElementById("left-joystick")
                          , r = l.querySelector(".thumbstick")
                          , u = document.getElementById("right-joystick")
                          , f = u.querySelector(".thumbstick")
                          , m = {
                            up: "t",
                            down: "g",
                            left: "f",
                            right: "h"
                        }
                          , p = {
                            up: "i",
                            down: "k",
                            left: "j",
                            right: "l"
                        };
                        let g = new Set
                          , h = new Set
                          , v = !1
                          , y = !1;
                        function E(e, t, n, o, i, d) {
                            // FIXED: Don't update joystick if controls are hidden
                            if (mobileControls.classList.contains('hidden')) {
                                return;
                            }
                            
                            const c = e.getBoundingClientRect();
                            let a = n - (c.left + c.width / 2)
                              , l = o - (c.top + c.height / 2);
                            const r = Math.sqrt(a * a + l * l);
                            r > 30 && (a = a / r * 30,
                            l = l / r * 30),
                            t.style.transform = `translate(calc(-50% + ${a}px), calc(-50% + ${l}px))`,
                            t.classList.add("pressed");
                            const u = new Set;
                            l < -15 && u.add(i.up),
                            l > 15 && u.add(i.down),
                            a < -15 && u.add(i.left),
                            a > 15 && u.add(i.right),
                            u.forEach((e => {
                                d.has(e) || (s(e, "keydown"),
                                d.add(e))
                            }
                            )),
                            d.forEach((e => {
                                u.has(e) || (s(e, "keyup"),
                                d.delete(e))
                            }
                            ))
                        }
                        function w(e, t) {
                            e.style.transform = "translate(-50%, -50%)",
                            e.classList.remove("pressed"),
                            t.forEach((e => {
                                s(e, "keyup")
                            }
                            )),
                            t.clear()
                        }
                        l.addEventListener("mousedown", (e => {
                            e.preventDefault(),
                            v = !0,
                            E(l, r, e.clientX, e.clientY, m, g)
                        }
                        )),
                        l.addEventListener("touchstart", (e => {
                            e.preventDefault(),
                            v = !0;
                            const t = e.touches[0];
                            E(l, r, t.clientX, t.clientY, m, g)
                        }
                        ), !1),
                        u.addEventListener("mousedown", (e => {
                            e.preventDefault(),
                            y = !0,
                            E(u, f, e.clientX, e.clientY, p, h)
                        }
                        )),
                        u.addEventListener("touchstart", (e => {
                            e.preventDefault(),
                            y = !0;
                            const t = e.touches[0];
                            E(u, f, t.clientX, t.clientY, p, h)
                        }
                        ), !1),
                        document.addEventListener("mousemove", (e => {
                            v && E(l, r, e.clientX, e.clientY, m, g),
                            y && E(u, f, e.clientX, e.clientY, p, h)
                        }
                        )),
                        document.addEventListener("touchmove", (e => {
                            e.preventDefault();
                            for (let t = 0; t < e.touches.length; t++) {
                                const n = e.touches[t];
                                v && E(l, r, n.clientX, n.clientY, m, g),
                                y && E(u, f, n.clientX, n.clientY, p, h)
                            }
                        }
                        ), {
                            passive: !1
                        }),
                        document.addEventListener("mouseup", ( () => {
                            v && (w(r, g),
                            v = !1),
                            y && (w(f, h),
                            y = !1)
                        }
                        )),
                        document.addEventListener("touchend", (e => {
                            0 === e.touches.length && (v && (w(r, g),
                            v = !1),
                            y && (w(f, h),
                            y = !1))
                        }
                        ))
                    }
                    ))
                </script>
            </div>
        </div>
    </body>
</html>
