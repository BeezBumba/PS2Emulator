<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <link rel="icon" href="/favicon.ico"/>
        <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,orientation=landscape"/>
        <meta name="theme-color" content="#000000"/>
        <meta name="description" content="A PlayStation2 emulator for web browsers"/>
        <meta name="google-adsense-account" content="ca-pub-6468293492439852">
        <link rel="apple-touch-icon" href="/play-192.png"/>
        <link rel="manifest" href="/manifest.json"/>
        <title>Play!.js</title>
       
        <style>
            @media screen and (orientation: portrait) {
                #orientation-warning {
                    display:flex!important
                }

                #mobile-controls {
                    display: none!important
                }
            }

            #orientation-warning {
                display: none;
                position: fixed;
                left: 0;
                top: 0;
                width: 100vw;
                height: 100vh;
                background: rgba(0,0,0,.85);
                color: #fff;
                z-index: 3000;
                align-items: center;
                justify-content: center;
                text-align: center;
                font-size: 2em;
                padding: 2em
            }

            body {
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                margin: 0;
                padding: 0;
                width: 100vw;
                height: 100vh;
                overflow: hidden;
                background: #000;
            }

            /* FIXED: React file input positioning - collapsible at top */
            #root {
                position: fixed;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                z-index: 10;
                pointer-events: auto;
            }

            /* File import toggle button */
            #file-import-toggle {
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 11;
                background: #333;
                color: #fff;
                border: none;
                border-radius: 6px;
                padding: 8px 12px;
                cursor: pointer;
                font-size: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                transition: background 0.2s;
            }

            #file-import-toggle:hover {
                background: #444;
            }

            /* Settings toggle button */
            #settings-toggle {
                position: fixed;
                top: 20px;
                left: 120px;
                z-index: 11;
                background: #333;
                color: #fff;
                border: none;
                border-radius: 6px;
                padding: 8px 12px;
                cursor: pointer;
                font-size: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                transition: background 0.2s;
            }

            #settings-toggle:hover {
                background: #444;
            }

            /* Controller status display */
            #controller-status {
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 11;
                background: rgba(0, 0, 0, 0.8);
                color: #fff;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 12px;
                font-family: monospace;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                min-width: 200px;
            }

            .controller-info {
                display: flex;
                align-items: center;
                gap: 8px;
                margin: 2px 0;
            }

            .controller-indicator {
                width: 8px;
                height: 8px;
                border-radius: 50%;
                background: #666;
                flex-shrink: 0;
            }

            .controller-indicator.connected {
                background: #4CAF50;
                box-shadow: 0 0 4px #4CAF50;
            }

            .controller-indicator.playstation {
                background: #2196F3;
                box-shadow: 0 0 4px #2196F3;
            }

            .controller-name {
                font-size: 11px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            /* Settings panel */
            #settings-panel {
                position: fixed;
                top: 60px;
                left: 120px;
                z-index: 10;
                background: rgba(0, 0, 0, 0.95);
                padding: 12px 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                border: 1px solid #444;
                transform: translateY(-100%);
                opacity: 0;
                transition: all 0.3s ease;
                pointer-events: none;
                min-width: 200px;
            }

            #settings-panel.expanded {
                transform: translateY(0);
                opacity: 1;
                pointer-events: auto;
            }

            #settings-panel label {
                display: block;
                color: #fff;
                font-weight: bold;
                margin-bottom: 8px;
                font-size: 14px;
            }

            #settings-panel select {
                width: 100%;
                padding: 8px 12px;
                border: 1px solid #666;
                border-radius: 4px;
                background-color: #444;
                color: #fff;
                font-size: 14px;
                cursor: pointer;
                font-family: inherit;
            }

            #settings-panel select:hover {
                background-color: #555;
                border-color: #777;
            }

            #settings-panel select:focus {
                outline: none;
                border-color: #007bff;
                box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
            }

            /* Collapsible file import panel */
            #root > div {
                background: rgba(0, 0, 0, 0.95);
                padding: 12px 16px;
                border-radius: 0 0 8px 8px;
                display: flex;
                align-items: center;
                gap: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
                border: 1px solid #444;
                border-top: none;
                transform: translateY(-100%);
                transition: transform 0.3s ease;
                min-width: 300px;
                justify-content: center;
            }

            #root.expanded > div {
                transform: translateY(0);
            }

            #root input[type="file"] {
                background: #444;
                color: #fff;
                border: 1px solid #666;
                border-radius: 4px;
                padding: 6px 10px;
                font-size: 14px;
                cursor: pointer;
                font-family: inherit;
            }

            #root input[type="file"]::-webkit-file-upload-button {
                background: #555;
                color: #fff;
                border: none;
                border-radius: 3px;
                padding: 4px 8px;
                margin-right: 8px;
                cursor: pointer;
                font-size: 12px;
            }

            #root input[type="file"]:hover {
                background: #555;
                border-color: #777;
            }

            #root .stats, #root .version {
                color: #ccc;
                font-size: 12px;
                font-family: monospace;
                white-space: nowrap;
            }

            #root .stats {
                color: #4CAF50;
            }

            #root .version {
                color: #2196F3;
            }

            #outputCanvas {
                display: block;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%,-50%);
                background: #000;
                z-index: 1;
                width: 100vw;
                height: 56.25vw;
                max-width: 100vw;
                max-height: 100vh;
                border-radius: 0
            }

            @media (max-width: 900px) and (orientation:landscape) {
                #outputCanvas {
                    width:100vw;
                    height: 56.25vw;
                    max-height: 100vh;
                    max-width: 100vw
                }
            }

            @media (max-width: 900px) and (orientation:portrait) {
                #outputCanvas {
                    width:100vw;
                    height: 100vw;
                    max-height: 100vh;
                    max-width: 100vw
                }
            }

            /* Touch controls toggle button */
            #touch-controls-toggle {
                position: fixed;
                top: 32px;
                right: 0;
                z-index: 2001;
                background: #222;
                color: #fff;
                border: none;
                border-radius: 8px 0 0 8px;
                box-shadow: 0 2px 8px #0004;
                padding: 8px 12px;
                cursor: pointer;
                transition: right .3s;
                font-size: 1.2em;
            }

            /* Touch controls visibility - FIXED: Complete transparency and disabled interaction */
            #mobile-controls.hidden {
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }

            .mc-actions button:active,.mc-center-buttons button:active,.mc-dpad button:active,.mc-joystick .thumbstick:active,.mc-shoulder-left button:active,.mc-shoulder-right button:active {
                filter: brightness(1.5) drop-shadow(0 0 8px #fff8);
                outline: 2px solid #fff;
                box-shadow: 0 0 16px #fff8
            }

            .mc-actions button.pressed,.mc-center-buttons button.pressed,.mc-dpad button.pressed,.mc-joystick .thumbstick.pressed,.mc-shoulder-left button.pressed,.mc-shoulder-right button.pressed {
                filter: brightness(1.5) drop-shadow(0 0 8px #fff8);
                outline: 2px solid #fff;
                box-shadow: 0 0 16px #fff8
            }

            #mobile-controls {
                position: fixed;
                left: 0;
                bottom: 0;
                width: 100vw;
                height: auto;
                pointer-events: none;
                z-index: 1000;
                display: flex;
                flex-direction: column;
                justify-content: flex-end;
                align-items: center
            }

            .mc-grid-container {
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
                width: 100%;
                padding: 0 3vw 2vh
            }

            .mc-left-column,.mc-right-column {
                display: flex;
                flex-direction: row;
                align-items: flex-end;
                gap: 20px;
                pointer-events: auto
            }

            .mc-center-buttons {
                pointer-events: auto;
                display: flex;
                align-items: center;
                gap: 16px;
                margin-bottom: 16px
            }

            .mc-center-buttons button {
                border-radius: 8px;
                padding: 8px 12px;
                font-size: .9em;
                background: #34495e;
                color: #fff;
                border: none;
                box-shadow: 0 2px 8px #0004
            }

            .mc-dpad {
                width: 160px;
                height: 160px;
                display: grid;
                grid-template-areas: ". up ." "left center right" ". down .";
                grid-template-columns: 1fr 1fr 1fr;
                grid-template-rows: 1fr 1fr 1fr;
                gap: 8px
            }

            .mc-dpad button {
                border-radius: 50%;
                width: 48px;
                height: 48px;
                font-size: 1.5em;
                background: #222;
                color: #fff;
                border: none;
                box-shadow: 0 2px 8px #0004;
            }

            .mc-dpad .up {
                grid-area: up;
            }

            .mc-dpad .down {
                grid-area: down;
            }

            .mc-dpad .left {
                grid-area: left;
            }

            .mc-dpad .right {
                grid-area: right;
            }

            .mc-dpad .center {
                grid-area: center;
                opacity: 0
            }

            .mc-actions {
                width: 180px;
                height: 200px;
                display: grid;
                grid-template-areas: 
                    ". . triangle . ."
                    ". square . circle ."
                    ". . cross . ."
                    ". . . . .";
                grid-template-columns: 1fr 1fr 1fr 1fr 1fr;
                grid-template-rows: 1fr 1fr 1fr 1fr;
                gap: 4px;
                align-items: center;
                justify-items: center;
            }

            .mc-actions button {
                border-radius: 50%;
                width: 54px;
                height: 54px;
                font-size: 1.2em;
                border: none;
                box-shadow: 0 2px 8px #0004
            }

            .mc-actions .triangle {
                grid-area: triangle;
                background: #333;
                color: #3ee3a1;
                border: 2px solid #555;
            }

            .mc-actions .square {
                grid-area: square;
                background: #333;
                color: #ff69f8;
                border: 2px solid #555;
            }

            .mc-actions .cross {
                grid-area: cross;
                background: #333;
                color: #7db3e9;
                border: 2px solid #555;
            }

            .mc-actions .circle {
                grid-area: circle;
                background: #333;
                color: #ff6666;
                border: 2px solid #555;
            }

            .mc-shoulder-left,.mc-shoulder-right {
                display: flex;
                flex-direction: column;
                gap: 8px
            }

            .mc-shoulder-left button,.mc-shoulder-right button {
                border-radius: 8px;
                padding: 8px 12px;
                font-size: .9em;
                background: #34495e;
                color: #fff;
                border: none;
                box-shadow: 0 2px 8px #0004
            }

            .mc-joystick {
                width: 120px;
                height: 120px;
                background: rgba(34,34,34,.5);
                border-radius: 50%;
                position: relative;
                box-shadow: 0 2px 8px #0004;
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none
            }

            .mc-joystick .thumbstick {
                width: 60px;
                height: 60px;
                background: #ddd;
                border-radius: 50%;
                box-shadow: inset 0 2px 4px #0004,0 1px 2px #fff8;
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%,-50%);
                touch-action: none;
                user-select: none;
                -webkit-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none
            }
        </style>
        <script defer="defer" src="/static/js/main.723be7a8.js"></script>
        <script defer src="/register.js"></script>
        <link href="/static/css/main.5a525eca.css" rel="stylesheet">
    </head>
    <body>
        <noscript>You need to enable JavaScript to run this app.</noscript>
        <div class="global-row">
            <div class="global-column">
                <div>
                    <canvas id="outputCanvas" width="640" height="480" tabindex="-1"/>
                    <div style="margin:16px 0">
                        <label for="main-file-input" style="font-weight:700;display:block;margin-bottom:8px">Choose a game file:</label>
                        <input type="file" id="main-file-input" style="width:100%;max-width:320px"/>
                    </div>
                </div>
                <button id="touch-controls-toggle" aria-label="Toggle touch controls">
                    üéÆ
                </button>
                <button id="file-import-toggle" aria-label="File Import">
                    üìÅ
                </button>
                <button id="settings-toggle" aria-label="Settings">
                    üîß
                </button>
                
                <!-- Controller Status Display -->
                <div id="controller-status">
                    <div class="controller-info">
                        <div class="controller-indicator" id="controller-1-indicator"></div>
                        <span class="controller-name" id="controller-1-name">Player 1: Keyboard</span>
                    </div>
                    <div class="controller-info">
                        <div class="controller-indicator" id="controller-2-indicator"></div>
                        <span class="controller-name" id="controller-2-name">Player 2: None</span>
                    </div>
                </div>
                
                <div id="settings-panel">
                    <label for="resolution-select">Resolution Scale:</label>
                    <select id="resolution-select">
                        <option value="1">1x (640√ó480)</option>
                        <option value="2">2x (1280√ó960)</option>
                        <option value="3">3x (1920√ó1440)</option>
                    </select>
                </div>
                <div id="root"></div>
                <div id="mobile-controls">
                    <div class="mc-grid-container">
                        <div class="mc-left-column">
                            <div class="mc-shoulder-left">
                                <button data-key="1">L1</button>
                                <button data-key="2">L2</button>
                                <button data-key="3">L3</button>
                            </div>
                            <div class="mc-left-side-stack">
                                <div class="mc-dpad">
                                    <button class="up" data-key="ArrowUp">‚ñ≤</button>
                                    <button class="left" data-key="ArrowLeft">‚óÄ</button>
                                    <button class="center" tabindex="-1"></button>
                                    <button class="right" data-key="ArrowRight">‚ñ∂</button>
                                    <button class="down" data-key="ArrowDown">‚ñº</button>
                                </div>
                                <div id="left-joystick" class="mc-joystick">
                                    <div class="thumbstick"></div>
                                </div>
                            </div>
                        </div>
                        <div class="mc-center-buttons">
                            <button data-key="Backspace">SELECT</button>
                            <button data-key="Enter">START</button>
                        </div>
                        <div class="mc-right-column">
                            <div class="mc-right-side-stack">
                                <div class="mc-actions">
                                    <button class="cross" data-key="Z">‚úï</button>
                                    <button class="square" data-key="A">‚ñ°</button>
                                    <button class="triangle" data-key="S">‚ñ≥</button>
                                    <button class="circle" data-key="X">‚óØ</button>
                                </div>
                                <div id="right-joystick" class="mc-joystick">
                                    <div class="thumbstick"></div>
                                </div>
                            </div>
                            <div class="mc-shoulder-right">
                                <button data-key="8">R1</button>
                                <button data-key="9">R2</button>
                                <button data-key="0">R3</button>
                            </div>
                        </div>
                    </div>
                </div>
           
                <div id="orientation-warning">
                    <div>
                        <div style="font-size:3em;margin-bottom:0.5em">üì±</div>
                        <div>Please rotate your device to landscape mode for the best gaming experience</div>
                    </div>
                </div>

                <script>
                    document.addEventListener("DOMContentLoaded", (function() {
                        // Enhanced Controller Management System
                        let connectedControllers = {};
                        let controllerPlayerMapping = {}; // Maps controller index to player number
                        let playerControllerMapping = {}; // Maps player number to controller index
                        let nextPlayerSlot = 1; // Next available player slot
                        let previousButtonStates = {};
                        let previousAxisStates = {};
                        
                        // Enhanced PlayStation Controller Detection
                        function isPlayStationController(gamepad) {
                            const id = gamepad.id.toLowerCase();
                            return id.includes('playstation') || 
                                   id.includes('dualshock') || 
                                   id.includes('dualsense') ||
                                   id.includes('wireless controller') ||
                                   id.includes('054c'); // Sony vendor ID
                        }
                        
                        // Enhanced Xbox Controller Detection
                        function isXboxController(gamepad) {
                            const id = gamepad.id.toLowerCase();
                            return id.includes('xbox') || 
                                   id.includes('xinput') ||
                                   id.includes('045e'); // Microsoft vendor ID
                        }
                        
                        // Generic controller detection
                        function getControllerType(gamepad) {
                            if (isPlayStationController(gamepad)) return 'PlayStation';
                            if (isXboxController(gamepad)) return 'Xbox';
                            return 'Generic';
                        }
                        
                        // Enhanced PlayStation Controller Button Mapping
                        const PS_BUTTON_MAPPING = {
                            // Face buttons (PlayStation layout)
                            0: { player1: 'Z', player2: 'N' },     // Cross (X)
                            1: { player1: 'X', player2: 'M' },     // Circle (O)  
                            2: { player1: 'A', player2: 'U' },     // Square
                            3: { player1: 'S', player2: 'Y' },     // Triangle
                            
                            // Shoulder buttons
                            4: { player1: '1', player2: 'Q' },     // L1
                            5: { player1: '8', player2: 'R' },     // R1
                            6: { player1: '2', player2: 'W' },     // L2
                            7: { player1: '9', player2: 'Numpad7' }, // R2
                            
                            // Center buttons
                            8: { player1: 'Backspace', player2: 'O' }, // Select/Share
                            9: { player1: 'Enter', player2: 'P' },     // Start/Options
                            
                            // Stick buttons
                            10: { player1: '3', player2: 'E' },    // L3
                            11: { player1: '0', player2: 'Numpad9' }, // R3
                            
                            // D-Pad
                            12: { player1: 'ArrowUp', player2: 'Numpad8' },    // Up
                            13: { player1: 'ArrowDown', player2: 'Numpad2' },  // Down
                            14: { player1: 'ArrowLeft', player2: 'Numpad4' },  // Left
                            15: { player1: 'ArrowRight', player2: 'Numpad6' }  // Right
                        };
                        
                        // Xbox Controller Button Mapping (different button order)
                        const XBOX_BUTTON_MAPPING = {
                            // Face buttons (Xbox layout)
                            0: { player1: 'Z', player2: 'N' },     // A (Cross equivalent)
                            1: { player1: 'X', player2: 'M' },     // B (Circle equivalent)
                            2: { player1: 'A', player2: 'U' },     // X (Square equivalent)
                            3: { player1: 'S', player2: 'Y' },     // Y (Triangle equivalent)
                            
                            // Shoulder buttons
                            4: { player1: '1', player2: 'Q' },     // LB (L1)
                            5: { player1: '8', player2: 'R' },     // RB (R1)
                            6: { player1: '2', player2: 'W' },     // LT (L2)
                            7: { player1: '9', player2: 'Numpad7' }, // RT (R2)
                            
                            // Center buttons
                            8: { player1: 'Backspace', player2: 'O' }, // Back/View
                            9: { player1: 'Enter', player2: 'P' },     // Start/Menu
                            
                            // Stick buttons
                            10: { player1: '3', player2: 'E' },    // Left stick
                            11: { player1: '0', player2: 'Numpad9' }, // Right stick
                            
                            // D-Pad
                            12: { player1: 'ArrowUp', player2: 'Numpad8' },    // Up
                            13: { player1: 'ArrowDown', player2: 'Numpad2' },  // Down
                            14: { player1: 'ArrowLeft', player2: 'Numpad4' },  // Left
                            15: { player1: 'ArrowRight', player2: 'Numpad6' }  // Right
                        };
                        
                        // Analog stick mappings
                        const ANALOG_MAPPING = {
                            player1: {
                                leftStick: { up: 'T', down: 'G', left: 'F', right: 'H' },
                                rightStick: { up: 'I', down: 'K', left: 'J', right: 'L' }
                            },
                            player2: {
                                leftStick: { up: 'C', down: 'Numpad0', left: 'V', right: 'B' },
                                rightStick: { up: 'Slash', down: 'Semicolon', left: 'Comma', right: 'Period' }
                            }
                        };
                        
                        // Controller status elements
                        const controller1Indicator = document.getElementById('controller-1-indicator');
                        const controller1Name = document.getElementById('controller-1-name');
                        const controller2Indicator = document.getElementById('controller-2-indicator');
                        const controller2Name = document.getElementById('controller-2-name');
                        
                        function updateControllerStatus() {
                            // Reset indicators
                            controller1Indicator.classList.remove('connected', 'playstation');
                            controller2Indicator.classList.remove('connected', 'playstation');
                            controller1Name.textContent = 'Player 1: Keyboard';
                            controller2Name.textContent = 'Player 2: None';
                            
                            // Update based on connected controllers
                            Object.keys(controllerPlayerMapping).forEach(controllerIndex => {
                                const playerNum = controllerPlayerMapping[controllerIndex];
                                const controller = connectedControllers[controllerIndex];
                                
                                if (!controller) return;
                                
                                const controllerType = getControllerType(controller);
                                const shortName = controller.id.length > 25 ? 
                                    controller.id.substring(0, 22) + '...' : 
                                    controller.id;
                                
                                if (playerNum === 1) {
                                    controller1Indicator.classList.add('connected');
                                    if (controllerType === 'PlayStation') {
                                        controller1Indicator.classList.add('playstation');
                                    }
                                    controller1Name.textContent = `Player 1: ${shortName}`;
                                } else if (playerNum === 2) {
                                    controller2Indicator.classList.add('connected');
                                    if (controllerType === 'PlayStation') {
                                        controller2Indicator.classList.add('playstation');
                                    }
                                    controller2Name.textContent = `Player 2: ${shortName}`;
                                }
                            });
                        }
                        
                        function simulateKeyPress(key, type) {
                            const canvas = document.getElementById("outputCanvas");
                            let code = "";
                            
                            // Convert key to proper code
                            if (key.length === 1) {
                                code = "Key" + key.toUpperCase();
                            } else if (key === "Enter") {
                                code = "Enter";
                            } else if (key === "Backspace") {
                                code = "Backspace";
                            } else if (key.startsWith("Arrow")) {
                                code = key;
                            } else if (key.startsWith("Numpad")) {
                                code = key;
                            } else if (["1", "2", "3", "8", "9", "0"].includes(key)) {
                                code = "Digit" + key;
                            } else if (key === "Comma") {
                                code = "Comma";
                            } else if (key === "Period") {
                                code = "Period";
                            } else if (key === "Slash") {
                                code = "Slash";
                            } else if (key === "Semicolon") {
                                code = "Semicolon";
                            }
                            
                            const event = new KeyboardEvent(type, {
                                key: key,
                                code: code,
                                bubbles: true,
                                cancelable: true,
                                isTrusted: true
                            });
                            
                            if (canvas) canvas.dispatchEvent(event);
                            window.dispatchEvent(event);
                            document.dispatchEvent(event);
                        }
                        
                        function handleControllerButton(controllerIndex, buttonIndex, pressed) {
                            const playerNum = controllerPlayerMapping[controllerIndex];
                            if (!playerNum) return;
                            
                            const controller = connectedControllers[controllerIndex];
                            if (!controller) return;
                            
                            // Choose the appropriate button mapping based on controller type
                            const controllerType = getControllerType(controller);
                            let mapping;
                            
                            if (controllerType === 'Xbox') {
                                mapping = XBOX_BUTTON_MAPPING[buttonIndex];
                            } else {
                                // Default to PlayStation mapping for PlayStation and Generic controllers
                                mapping = PS_BUTTON_MAPPING[buttonIndex];
                            }
                            
                            if (!mapping) return;
                            
                            const key = playerNum === 1 ? mapping.player1 : mapping.player2;
                            const eventType = pressed ? 'keydown' : 'keyup';
                            
                            simulateKeyPress(key, eventType);
                            console.log(`Controller ${controllerIndex} (${controllerType}, Player ${playerNum}): Button ${buttonIndex} ${pressed ? 'pressed' : 'released'} -> ${key}`);
                        }
                        
                        function handleControllerAxis(controllerIndex, axisIndex, value) {
                            const playerNum = controllerPlayerMapping[controllerIndex];
                            if (!playerNum) return;
                            
                            const playerKey = playerNum === 1 ? 'player1' : 'player2';
                            const analogMapping = ANALOG_MAPPING[playerKey];
                            
                            const deadzone = 0.25; // Slightly reduced deadzone for better responsiveness
                            let stickMapping = null;
                            
                            // Determine which stick and axis
                            if (axisIndex === 0 || axisIndex === 1) {
                                // Left stick
                                stickMapping = analogMapping.leftStick;
                            } else if (axisIndex === 2 || axisIndex === 3) {
                                // Right stick  
                                stickMapping = analogMapping.rightStick;
                            }
                            
                            if (!stickMapping) return;
                            
                            // Get previous axis state
                            if (!previousAxisStates[controllerIndex]) {
                                previousAxisStates[controllerIndex] = {};
                            }
                            const prevValue = previousAxisStates[controllerIndex][axisIndex] || 0;
                            
                            // Handle horizontal axis (0 = left stick X, 2 = right stick X)
                            if (axisIndex === 0 || axisIndex === 2) {
                                // Release previous keys if axis changed significantly
                                if (Math.abs(value - prevValue) > 0.1) {
                                    simulateKeyPress(stickMapping.left, 'keyup');
                                    simulateKeyPress(stickMapping.right, 'keyup');
                                }
                                
                                if (value < -deadzone) {
                                    simulateKeyPress(stickMapping.left, 'keydown');
                                } else if (value > deadzone) {
                                    simulateKeyPress(stickMapping.right, 'keydown');
                                }
                            }
                            
                            // Handle vertical axis (1 = left stick Y, 3 = right stick Y)
                            if (axisIndex === 1 || axisIndex === 3) {
                                // Release previous keys if axis changed significantly
                                if (Math.abs(value - prevValue) > 0.1) {
                                    simulateKeyPress(stickMapping.up, 'keyup');
                                    simulateKeyPress(stickMapping.down, 'keyup');
                                }
                                
                                if (value < -deadzone) {
                                    simulateKeyPress(stickMapping.up, 'keydown');
                                } else if (value > deadzone) {
                                    simulateKeyPress(stickMapping.down, 'keydown');
                                }
                            }
                            
                            // Store current axis state
                            previousAxisStates[controllerIndex][axisIndex] = value;
                        }
                        
                        // Enhanced controller event listeners
                        window.addEventListener("gamepadconnected", function(e) {
                            console.log("Controller connected:", e.gamepad.id);
                            connectedControllers[e.gamepad.index] = e.gamepad;
                            
                            const controllerType = getControllerType(e.gamepad);
                            console.log(`Detected ${controllerType} controller`);
                            
                            // Assign to next available player slot
                            if (nextPlayerSlot <= 2) {
                                controllerPlayerMapping[e.gamepad.index] = nextPlayerSlot;
                                playerControllerMapping[nextPlayerSlot] = e.gamepad.index;
                                console.log(`Controller ${e.gamepad.index} assigned to Player ${nextPlayerSlot}`);
                                nextPlayerSlot++;
                            } else {
                                console.log(`Controller ${e.gamepad.index} connected but no player slots available`);
                            }
                            
                            updateControllerStatus();
                        });
                        
                        window.addEventListener("gamepaddisconnected", function(e) {
                            console.log("Controller disconnected:", e.gamepad.id);
                            
                            // Free up the player slot
                            const playerNum = controllerPlayerMapping[e.gamepad.index];
                            if (playerNum) {
                                delete controllerPlayerMapping[e.gamepad.index];
                                delete playerControllerMapping[playerNum];
                                
                                // Reset next player slot to the lowest available
                                nextPlayerSlot = Math.min(nextPlayerSlot, playerNum);
                                
                                // Release any held keys for this controller
                                if (previousButtonStates[e.gamepad.index]) {
                                    delete previousButtonStates[e.gamepad.index];
                                }
                                if (previousAxisStates[e.gamepad.index]) {
                                    delete previousAxisStates[e.gamepad.index];
                                }
                            }
                            
                            delete connectedControllers[e.gamepad.index];
                            updateControllerStatus();
                        });
                        
                        // Enhanced controller polling loop
                        function pollControllers() {
                            const gamepads = navigator.getGamepads();
                            
                            for (let i = 0; i < gamepads.length; i++) {
                                const gamepad = gamepads[i];
                                if (!gamepad || !controllerPlayerMapping[i]) continue;
                                
                                // Update connected controllers array
                                connectedControllers[i] = gamepad;
                                
                                // Initialize previous state if needed
                                if (!previousButtonStates[i]) {
                                    previousButtonStates[i] = new Array(gamepad.buttons.length).fill(false);
                                }
                                
                                // Check buttons
                                for (let j = 0; j < gamepad.buttons.length; j++) {
                                    const button = gamepad.buttons[j];
                                    const pressed = button.pressed || button.value > 0.5;
                                    const wasPressed = previousButtonStates[i][j];
                                    
                                    if (pressed !== wasPressed) {
                                        handleControllerButton(i, j, pressed);
                                        previousButtonStates[i][j] = pressed;
                                    }
                                }
                                
                                // Check axes (analog sticks)
                                for (let j = 0; j < gamepad.axes.length; j++) {
                                    handleControllerAxis(i, j, gamepad.axes[j]);
                                }
                            }
                            
                            requestAnimationFrame(pollControllers);
                        }
                        
                        // Start controller polling
                        pollControllers();

                        // Mobile controls functionality
                        const mobileControls = document.getElementById("mobile-controls");
                        const touchControlsToggle = document.getElementById("touch-controls-toggle");
                        
                        let controlsVisible = false;
                        
                        function toggleTouchControls() {
                            controlsVisible = !controlsVisible;
                            if (controlsVisible) {
                                mobileControls.classList.remove('hidden');
                                touchControlsToggle.style.right = '0';
                            } else {
                                mobileControls.classList.add('hidden');
                                touchControlsToggle.style.right = '-10px';
                            }
                        }
                        
                        // Initially hide controls
                        mobileControls.classList.add('hidden');
                        touchControlsToggle.style.right = '-10px';
                        
                        touchControlsToggle.addEventListener('click', toggleTouchControls);

                        // File import functionality
                        const rootDiv = document.getElementById("root");
                        const fileImportToggle = document.getElementById("file-import-toggle");
                        
                        function toggleFileImport() {
                            rootDiv.classList.toggle('expanded');
                        }
                        
                        fileImportToggle.addEventListener('click', toggleFileImport);

                        // Settings panel functionality
                        const settingsToggle = document.getElementById("settings-toggle");
                        const settingsPanel = document.getElementById("settings-panel");
                        
                        function toggleSettings() {
                            settingsPanel.classList.toggle('expanded');
                        }
                        
                        settingsToggle.addEventListener('click', toggleSettings);

                        // Resolution scaling functionality
                        const resolutionSelect = document.getElementById("resolution-select");
                        
                        resolutionSelect.addEventListener('change', function() {
                            const scale = parseInt(this.value);
                            console.log(`Setting resolution scale to ${scale}x`);
                            
                            // Call the emulator's resolution scaling function
                            if (typeof Module !== 'undefined' && Module.setResolutionScale) {
                                Module.setResolutionScale(scale);
                            }
                        });

                        // Touch controls for mobile
                        function s(e, t) {
                            const n = document.getElementById("outputCanvas");
                            let o = "";
                            1 === e.length ? o = "Key" + e.toUpperCase() : "Enter" === e ? o = "Enter" : "Backspace" === e ? o = "Backspace" : e.startsWith("Arrow") ? o = e : e.startsWith("Numpad") ? o = e : ["1", "2", "3", "8", "9", "0"].includes(e) ? o = "Digit" + e : "Comma" === e ? o = "Comma" : "Period" === e ? o = "Period" : "Slash" === e ? o = "Slash" : "Semicolon" === e && (o = "Semicolon");
                            const i = new KeyboardEvent(t,{
                                key: e,
                                code: o,
                                bubbles: !0,
                                cancelable: !0,
                                isTrusted: !0
                            });
                            n && n.dispatchEvent(i),
                            window.dispatchEvent(i),
                            document.dispatchEvent(i)
                        }
                        function c(e, t) {
                            s(t, "keydown"),
                            e.classList.add("pressed")
                        }
                        function a(e, t) {
                            s(t, "keyup"),
                            e.classList.remove("pressed")
                        }
                        document.querySelectorAll("#mobile-controls button[data-key]").forEach((function(e) {
                            const t = e.getAttribute("data-key");
                            e.addEventListener("touchstart", (function(n) {
                                n.preventDefault(),
                                c(e, t)
                            }
                            )),
                            e.addEventListener("mousedown", (function(n) {
                                n.preventDefault(),
                                c(e, t)
                            }
                            )),
                            e.addEventListener("touchend", (function(n) {
                                n.preventDefault(),
                                a(e, t)
                            }
                            )),
                            e.addEventListener("mouseup", (function(n) {
                                n.preventDefault(),
                                a(e, t)
                            }
                            )),
                            e.addEventListener("mouseleave", (function(n) {
                                1 === n.buttons && a(e, t)
                            }
                            ))
                        }
                        ));
                        const l = document.getElementById("left-joystick")
                          , r = l.querySelector(".thumbstick")
                          , u = document.getElementById("right-joystick")
                          , f = u.querySelector(".thumbstick")
                          , m = {
                            up: "t",
                            down: "g",
                            left: "f",
                            right: "h"
                        }
                          , p = {
                            up: "i",
                            down: "k",
                            left: "j",
                            right: "l"
                        };
                        let g = new Set
                          , h = new Set
                          , v = !1
                          , y = !1;
                        function E(e, t, n, o, i, d) {
                            // FIXED: Don't update joystick if controls are hidden
                            if (mobileControls.classList.contains('hidden')) {
                                return;
                            }
                            
                            const c = e.getBoundingClientRect();
                            let a = n - (c.left + c.width / 2)
                              , l = o - (c.top + c.height / 2);
                            const r = Math.sqrt(a * a + l * l);
                            r > 30 && (a = a / r * 30,
                            l = l / r * 30),
                            t.style.transform = `translate(calc(-50% + ${a}px), calc(-50% + ${l}px))`,
                            t.classList.add("pressed");
                            const u = new Set;
                            l < -15 && u.add(i.up),
                            l > 15 && u.add(i.down),
                            a < -15 && u.add(i.left),
                            a > 15 && u.add(i.right),
                            u.forEach((e => {
                                d.has(e) || (s(e, "keydown"),
                                d.add(e))
                            }
                            )),
                            d.forEach((e => {
                                u.has(e) || (s(e, "keyup"),
                                d.delete(e))
                            }
                            ))
                        }
                        function w(e, t) {
                            e.style.transform = "translate(-50%, -50%)",
                            e.classList.remove("pressed"),
                            t.forEach((e => {
                                s(e, "keyup")
                            }
                            )),
                            t.clear()
                        }
                        l.addEventListener("mousedown", (e => {
                            e.preventDefault(),
                            v = !0,
                            E(l, r, e.clientX, e.clientY, m, g)
                        }
                        )),
                        l.addEventListener("touchstart", (e => {
                            e.preventDefault(),
                            v = !0;
                            const t = e.touches[0];
                            E(l, r, t.clientX, t.clientY, m, g)
                        }
                        ), !1),
                        u.addEventListener("mousedown", (e => {
                            e.preventDefault(),
                            y = !0,
                            E(u, f, e.clientX, e.clientY, p, h)
                        }
                        )),
                        u.addEventListener("touchstart", (e => {
                            e.preventDefault(),
                            y = !0;
                            const t = e.touches[0];
                            E(u, f, t.clientX, t.clientY, p, h)
                        }
                        ), !1),
                        document.addEventListener("mousemove", (e => {
                            v && E(l, r, e.clientX, e.clientY, m, g),
                            y && E(u, f, e.clientX, e.clientY, p, h)
                        }
                        )),
                        document.addEventListener("touchmove", (e => {
                            if (v || y) {
                                e.preventDefault();
                                for (let t = 0; t < e.touches.length; t++) {
                                    const n = e.touches[t];
                                    v && E(l, r, n.clientX, n.clientY, m, g),
                                    y && E(u, f, n.clientX, n.clientY, p, h)
                                }
                            }
                        }
                        ), {
                            passive: !1
                        }),
                        document.addEventListener("mouseup", ( () => {
                            v && (w(r, g),
                            v = !1),
                            y && (w(f, h),
                            y = !1)
                        }
                        )),
                        document.addEventListener("touchend", (e => {
                            0 === e.touches.length && (v && (w(r, g),
                            v = !1),
                            y && (w(f, h),
                            y = !1))
                        }
                        ))
                    }));
                </script>
            </div>
        </div>
    </body>
</html>
